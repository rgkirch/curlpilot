#!/bin/bash

set -euox pipefail

# curlpilot/copilot/embed

source "$(dirname "$0")/../deps.bash"

# Define API_ENDPOINT directly from copilot/config.bash
API_ENDPOINT="https://api.githubcopilot.com/chat/completions"

# Register and source dependencies
register auth "copilot/auth.bash"
exec_dep auth

# Get the input text from command line arguments
if [ -z "${1:-}" ]; then
  echo "Usage: $(basename "$0") <text_to_embed>"
  exit 1
fi

INPUT_TEXT="$1"

# Construct the JSON payload for the completions endpoint with the embedding model
JSON_PAYLOAD=$(jq -n \
  --arg input_text "$INPUT_TEXT" \
  '{
    "input": $input_text,
    "model": "text-embedding-3-small"
  }')

# Make the curl request directly
curl -sS -N -X POST \
  "$API_ENDPOINT" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ${COPILOT_SESSION_TOKEN}" \
  -H "Openai-Intent: conversation-panel" \
  -H "X-Request-Id: $(uuidgen)" \
  -H "Vscode-Sessionid: some-session-id" \
  -H "Vscode-Machineid: some-machine-id" \
  -H "Copilot-Integration-Id: vscode-chat" \
  -H "Editor-Plugin-Version: gptel/*" \
  -H "Editor-Version: emacs/29.1" \
  -d "$JSON_PAYLOAD" \
  --write-out '\0
{
    "http_code": %{http_code},
    "exitcode": %{exitcode},
    "errormsg": "% {errormsg}"
}'
